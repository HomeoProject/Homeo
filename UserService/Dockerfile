FROM gradle:jdk17-alpine AS build
COPY --chown=gradle:gradle . /home/gradle/UserService
WORKDIR /home/gradle/UserService
RUN gradle clean build -x test
#COPY .env .env
#RUN export $(grep -v '^#' .env | xargs) && gradle build --no-daemon

FROM openjdk:17-jdk-alpine
WORKDIR /app

# ENV variables to replace
ARG PORT_USERSERVICE
ARG HIKARI_MAX_POOL_SIZE
ARG HIKARI_MINIMUM_IDLE
ARG OKTA_API_ISSUER
ARG OKTA_API_AUDIENCE
ARG OKTA_API_DOMAIN
ARG OKTA_MTM_CLIENT_ID
ARG OKTA_MTM_CLIENT_SECRET
ARG OKTA_MANAGEMENT_API_AUDIENCE
ARG OKTA_AUTH0_CONSTRUCTOR_ROLE_ID
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD
ARG POSTGRES_URL_USERSERVICE
ARG EUREKA_URL
ARG CLOUDINARY_API_KEY
ARG CLOUDINARY_CLOUD_NAME
ARG CLOUDINARY_API_SECRET
ARG CLOUDINARY_FOLDER_NAME
ARG CLOUDINARY_DEFAULT_AVATAR_URL
ARG OPENAPI_URL
ARG OKTA_AUTH0_USER_ROLE_ID
ARG RABBITMQ_HOST
ARG RABBITMQ_PORT
ARG RABBITMQ_USER
ARG RABBITMQ_PASSWORD

ENV PORT=${PORT_USERSERVICE:-8080}
ENV HIKARI_MAX_POOL_SIZE=${HIKARI_MAX_POOL_SIZE:-10}
ENV HIKARI_MINIMUM_IDLE=${HIKARI_MINIMUM_IDLE:-10}
ENV OKTA_API_ISSUER=${OKTA_API_ISSUER:-REPLACE}
ENV OKTA_API_AUDIENCE=${OKTA_API_AUDIENCE:-REPLACE}
ENV OKTA_API_DOMAIN=${OKTA_API_DOMAIN:-REPLACE}
ENV OKTA_MTM_CLIENT_ID=${OKTA_MTM_CLIENT_ID:-REPLACE}
ENV OKTA_MTM_CLIENT_SECRET=${OKTA_MTM_CLIENT_SECRET:-REPLACE}
ENV OKTA_MANAGEMENT_API_AUDIENCE=${OKTA_MANAGEMENT_API_AUDIENCE:-REPLACE}
ENV OKTA_AUTH0_CONSTRUCTOR_ROLE_ID=${OKTA_AUTH0_CONSTRUCTOR_ROLE_ID:-REPLACE}
ENV POSTGRES_USER=${POSTGRES_USER:-REPLACE}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-REPLACE}
ENV POSTGRES_URL=${POSTGRES_URL_USERSERVICE:-REPLACE}
ENV EUREKA_URL=${EUREKA_URL:-REPLACE}
ENV CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY:-REPLACE}
ENV CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME:-REPLACE}
ENV CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET:-REPLACE}
ENV CLOUDINARY_FOLDER_NAME=${CLOUDINARY_FOLDER_NAME:-REPLACE}
ENV CLOUDINARY_DEFAULT_AVATAR_URL=${CLOUDINARY_DEFAULT_AVATAR_URL:-REPLACE}
ENV OPENAPI_URL=${OPENAPI_URL:-REPLACE}
ENV OKTA_AUTH0_USER_ROLE_ID=${OKTA_AUTH0_USER_ROLE_ID:-REPLACE}
ENV RABBITMQ_HOST=${RABBITMQ_HOST:-REPLACE}
ENV RABBITMQ_PORT=${RABBITMQ_PORT:-REPLACE}
ENV RABBITMQ_USER=${RABBITMQ_USER:-REPLACE}
ENV RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-REPLACE}

COPY --from=build /home/gradle/UserService/build/libs/UserService-0.0.1-SNAPSHOT.jar /app
COPY --from=build /home/gradle/UserService/build/output/libs/opentelemetry-javaagent.jar /app

ENTRYPOINT ["java","-jar","UserService-0.0.1-SNAPSHOT.jar"]
