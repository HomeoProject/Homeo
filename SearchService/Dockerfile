FROM gradle:jdk17-alpine AS build
COPY --chown=gradle:gradle . /home/gradle/SearchService
WORKDIR /home/gradle/SearchService
RUN gradle clean build -x test

FROM openjdk:17-jdk-alpine
WORKDIR /app
COPY --from=build /home/gradle/SearchService/build/libs/SearchService-0.0.1-SNAPSHOT.jar /app
COPY --from=build /home/gradle/SearchService/build/output/libs/opentelemetry-javaagent.jar /app

ARG PORT_SEARCHSERVICE
ARG HIKARI_MAX_POOL_SIZE
ARG HIKARI_MINIMUM_IDLE
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD
ARG POSTGRES_URL_SEARCHSERVICE
ARG EUREKA_URL
ARG OPENAPI_URL
ARG RABBITMQ_HOST
ARG RABBITMQ_PORT
ARG RABBITMQ_USER
ARG RABBITMQ_PASSWORD

ENV PORT=${PORT_SEARCHSERVICE:-8080}
ENV HIKARI_MAX_POOL_SIZE=${HIKARI_MAX_POOL_SIZE:-10}
ENV HIKARI_MINIMUM_IDLE=${HIKARI_MINIMUM_IDLE:-10}
ENV POSTGRES_USER=${POSTGRES_USER:-REPLACE}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-REPLACE}
ENV POSTGRES_URL=${POSTGRES_URL_SEARCHSERVICE:-REPLACE}
ENV EUREKA_URL=${EUREKA_URL:-REPLACE}
ENV OPENAPI_URL=${OPENAPI_URL:-REPLACE}
ENV RABBITMQ_HOST=${RABBITMQ_HOST:-REPLACE}
ENV RABBITMQ_PORT=${RABBITMQ_PORT:-REPLACE}
ENV RABBITMQ_USER=${RABBITMQ_USER:-REPLACE}
ENV RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-REPLACE}
ENV FEIGN_URL_REVIEWSERVICE=${FEIGN_URL_REVIEWSERVICE:-}
ENV FEIGN_URL_USERSERVICE=${FEIGN_URL_USERSERVICE:-}
ENV FEIGN_URL_CONSTRUCTORSERVICE=${FEIGN_URL_CONSTRUCTORSERVICE:-}

ENTRYPOINT ["java","-jar","SearchService-0.0.1-SNAPSHOT.jar"]